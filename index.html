<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–µè¯­æŸ æª¬å›¢æœ¬åˆ†ç»„</title>
    <!-- æ›¿æ¢ï¼šæµè§ˆå™¨æ ‡ç­¾é¡µå›¾æ ‡ (Favicon)ï¼Œç°åœ¨ä½¿ç”¨æŸ æª¬è¡¨æƒ…ç¬¦å· ğŸ‹ -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ‹</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- 1. å¼•å…¥ SheetJS (ç”¨äºè¯»å– Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Helvetica Neue', 'Arial', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background-color: #f3f4f6;
            /* é˜²æ­¢æ‹–æ‹½æ—¶é€‰ä¸­æ–‡å­— */
            user-select: none;
            -webkit-user-select: none;
        }
        /* è‡ªå®šä¹‰è¡¨å•æ§ä»¶æ ·å¼ */
        .form-radio {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            display: inline-block;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 9999px;
            border: 2px solid #cbd5e1;
            transition: all 0.2s;
            cursor: pointer;
            vertical-align: middle;
            margin-right: 0.5rem;
        }
        .form-radio:checked {
            border-color: #4f46e5;
            background-color: #4f46e5;
            border-width: 4px; /* åˆ›å»ºå†…éƒ¨åœ†ç‚¹æ•ˆæœ */
        }
        .form-checkbox {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            display: inline-block;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 0.375rem;
            border: 2px solid #cbd5e1;
            transition: all 0.2s;
            cursor: pointer;
            vertical-align: middle;
            margin-right: 0.5rem;
            position: relative;
        }
        .form-checkbox:checked {
            border-color: #4f46e5;
            background-color: #4f46e5;
        }
        .form-checkbox:checked::after {
            content: '\2713'; /* checkmark */
            display: block;
            color: white;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            font-weight: 700;
            line-height: 1;
        }
        .btn-primary {
            @apply bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all duration-200 ease-in-out;
        }
        .btn-danger {
            @apply bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-all duration-200 ease-in-out;
        }
        .btn-secondary {
            @apply bg-gray-500 text-white font-semibold py-1 px-3 rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition-all duration-200 ease-in-out;
        }

        /* æ‹–æ‹½æ ·å¼ */
        .member-item[draggable="true"] {
            cursor: grab;
            transition: background-color 0.2s, opacity 0.2s;
        }
        .member-item[draggable="true"]:active {
            cursor: grabbing;
        }
        .dragging {
            opacity: 0.4;
            background: #e0e7ff;
        }
        .drag-over-target {
            /* å½“ä¸€ä¸ªå…ƒç´ è¢«æ‹–åˆ°å®ƒä¸Šé¢æ—¶çš„æ ·å¼ */
            background-color: #c7d2fe;
            outline: 2px dashed #4f46e5;
            outline-offset: -2px;
        }

        /* Drop Zone æ ·å¼ */
        .drop-zone {
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 120px;
            border: 2px dashed #9ca3af; /* ç°è‰²è™šçº¿ */
            transition: border-color 0.2s, background-color 0.2s;
            cursor: pointer;
        }
        .drop-zone:hover {
            border-color: #6366f1; /* é¼ æ ‡æ‚¬åœå˜è‰² */
        }
        .drop-zone.drag-over {
            border-color: #4f46e5 !important; /* æ‹–æ‹½æ—¶å˜è“è‰² */
            background-color: #e0e7ff; /* æµ…è“è‰²èƒŒæ™¯ */
        }
        /* éšè—åŸå§‹æ–‡ä»¶è¾“å…¥æ¡† */
        #excel-file-input {
            display: none;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">

        <header class="mb-8 p-6 bg-white rounded-xl shadow-lg border border-gray-200">
            <h1 class="text-3xl font-bold text-gray-900 flex items-center">
                <!-- ä¸»æ ‡é¢˜ Logo ä¿æŒä¸å˜ï¼Œä½¿ç”¨ Cat Head -->
                <i class="ph-fill ph-cat-head text-orange-500 mr-3 text-4xl"></i>
                å–µè¯­æŸ æª¬å›¢æœ¬åˆ†é…
            </h1>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- å·¦ä¾§ï¼šæ·»åŠ æˆå‘˜ä¸åˆ—è¡¨ -->
            <div class="lg:col-span-1 space-y-6">
                <!-- æ·»åŠ æˆå‘˜è¡¨å• -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-5 border-b pb-3 flex items-center">
                        <i class="ph-bold ph-user-plus text-xl mr-2"></i>æ·»åŠ æˆå‘˜
                    </h2>
                    <form id="add-member-form" class="space-y-4">
                        <div>
                            <label for="gameId" class="block text-sm font-medium text-gray-700 mb-1">æ¸¸æˆID (å¿…å¡«)</label>
                            <input type="text" id="gameId" name="gameId" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                   placeholder="ä¾‹å¦‚: ç‡•äº‘å´å½¦ç¥–">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">èŒä¸š (å¿…é€‰)</label>
                            <div class="flex space-x-4">
                                <label for="role-output" class="flex items-center cursor-pointer">
                                    <input type="radio" id="role-output" name="role" value="output" required class="form-radio" checked>
                                    <span class="text-gray-700">è¾“å‡º</span>
                                </label>
                                <label for="role-healer" class="flex items-center cursor-pointer">
                                    <input type="radio" id="role-healer" name="role" value="healer" class="form-radio">
                                    <span class="text-gray-700">å¥¶å¦ˆ</span>
                                </label>
                            </div>
                        </div>

                        <div class="flex items-center justify-between pt-2 space-x-4">
                            <label for="isCommander" class="flex items-center cursor-pointer text-gray-700 font-medium">
                                <input type="checkbox" id="isCommander" name="isCommander" class="form-checkbox">
                                æ˜¯æŒ‡æŒ¥
                            </label>
                            <label for="isHighLevel" class="flex items-center cursor-pointer text-gray-700 font-medium">
                                <input type="checkbox" id="isHighLevel" name="isHighLevel" class="form-checkbox">
                                æœ‰å…­é‡å¿ƒæ³• (é«˜æˆ˜åŠ›)
                            </label>
                        </div>

                        <!-- æ–°å¢ï¼šå¤‡æ³¨ -->
                        <div>
                            <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">å¤‡æ³¨</label>
                            <input type="text" id="notes" name="notes"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                   placeholder="ä¾‹å¦‚: æ†ç»‘XX, å¤ºèˆ">
                        </div>

                        <button type="submit" class="w-full btn-primary mt-4 py-3 text-base">
                            <i class="ph-fill ph-plus-circle mr-1"></i>
                            æ·»åŠ è‡³åˆ—è¡¨
                        </button>
                    </form>

                    <!-- æ–°å¢ï¼šExcel å¯¼å…¥ (æ‹–æ‹½åŒº) -->
                    <div class="mt-6 border-t pt-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3 flex items-center">
                           <i class="ph-bold ph-file-xls text-xl mr-2"></i>æˆ– æ‰¹é‡å¯¼å…¥
                        </h3>
                        <!-- Drop Zone -->
                        <div id="drop-zone" class="drop-zone p-4 transition-colors hover:bg-gray-50">
                            <i class="ph-bold ph-file-xls text-3xl text-gray-500 mb-2"></i>
                            <p class="font-medium text-gray-700">å°† Excel æ–‡ä»¶æ‹–æ”¾åˆ°æ­¤å¤„</p>
                            <p class="text-sm text-gray-500 mt-1">æˆ– <span id="click-to-upload" class="text-indigo-600 font-semibold underline">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</span></p>
                            <input type="file" id="excel-file-input" accept=".xlsx, .xls">
                        </div>
                         <p class="text-xs text-gray-500 mt-2">
                             åˆ—åéœ€åŒ…å«: `é©¾é©¶å‘˜id`, `æ˜¯å¦æ˜¯å¥¶å¦ˆ`, `æ˜¯å¦æ˜¯æŒ‡æŒ¥`, `æ˜¯å¦æœ‰æœ¬æµæ´¾å…­é‡å¿ƒæ³•`, `å¤‡æ³¨`ã€‚
                         </p>
                    </div>

                </div>

                <!-- æˆå‘˜åˆ—è¡¨ -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-5 border-b pb-3 flex items-center justify-between">
                        <span class="flex items-center"><i class="ph-bold ph-list-numbers text-xl mr-2"></i>æŠ¥ååˆ—è¡¨</span>
                        <!-- åˆ·æ–°æŒ‰é’®å·²ç§»é™¤ -->
                        <span id="member-count" class="text-lg font-bold text-indigo-600 bg-indigo-100 px-3 py-1 rounded-full">0 äºº</span>
                    </h2>
                    <div id="member-list-container" class="max-h-96 overflow-y-auto pr-2 space-y-3">
                        <p id="empty-list-msg" class="text-gray-500 text-center py-4">æš‚æ— æˆå‘˜ï¼Œè¯·åœ¨ä¸Šæ–¹æ·»åŠ æˆ–å¯¼å…¥Excelã€‚</p>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæ§åˆ¶ä¸ç»“æœ -->
            <div class="lg:col-span-2 space-y-6">
                <!-- æ§åˆ¶é¢æ¿ -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-5 border-b pb-3 flex items-center">
                        <i class="ph-bold ph-gear-six text-xl mr-2"></i>å¼€å§‹æ’å›¢
                    </h2>
                    <div class="flex space-x-4">
                        <button id="arrange-teams-btn" class="flex-1 btn-primary py-3 text-lg">
                            <i class="ph-fill ph-rocket-launch mr-1"></i>
                            å¼€å§‹è‡ªåŠ¨åˆ†è½¦
                        </button>
                        <button id="reset-all-btn" class="flex-1 btn-danger py-3 text-lg">
                            <i class="ph-fill ph-trash mr-1"></i>
                            æ¸…ç©ºæ‰€æœ‰æ•°æ®
                        </button>
                    </div>
                    <div id="error-message" class="mt-4 text-red-600 font-medium text-center"></div>
                    <div id="debug-error-message" class="mt-2 text-xs text-gray-500 text-center"></div>
                </div>

                <!-- ç»“æœåŒºåŸŸ -->
                <div class="space-y-6">
                    <!-- å›¢é˜Ÿåˆ—è¡¨ -->
                    <div>
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="ph-bold ph-users text-xl mr-2 text-green-600"></i>
                            å·²æˆå›¢åˆ—è¡¨ (<span id="team-count">0</span> è½¦)
                        </h2>
                        <div id="teams-output" class="space-y-5">
                            <!-- å›¢é˜Ÿå¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€æ’å…¥ -->
                        </div>
                    </div>

                    <!-- æ›¿è¡¥åˆ—è¡¨ -->
                    <div>
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="ph-bold ph-user-gear text-xl mr-2 text-yellow-600"></i>
                            æ›¿è¡¥å¸­ (<span id="sub-count">0</span> äºº)
                        </h2>
                        <div id="subs-output" class="bg-white p-5 rounded-xl shadow-lg border border-gray-200">
                            <div id="subs-list" class="flex flex-wrap gap-3">
                                <p id="empty-subs-msg" class="text-gray-500">æš‚æ— æ›¿è¡¥äººå‘˜ã€‚</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. æœ¬åœ°è®¡ç®—å™¨è„šæœ¬ -->
    <script>
        // ===================================================
        // === å…¨å±€å˜é‡å’Œ DOM å¼•ç”¨ ===
        // ===================================================

        // æ ¸å¿ƒæ•°æ®ï¼šæ‰€æœ‰æˆå‘˜çš„åˆ—è¡¨
        // ç»“æ„: [{ uniqueId: "...", id: "GameID", role: "...", ... }]
        let localMembers = [];

        // æ ¸å¿ƒæ•°æ®ï¼šåˆ†è½¦ç»“æœ
        let generatedTeams = [];
        let generatedHLTargets = {};

        // æ‹–æ‹½æ•°æ®
        let draggedMemberUniqueId = null;

        // DOM å…ƒç´ å¼•ç”¨
        const addMemberForm = document.getElementById('add-member-form');
        const memberListContainer = document.getElementById('member-list-container');
        const emptyListMsg = document.getElementById('empty-list-msg');
        const memberCountSpan = document.getElementById('member-count');

        const arrangeBtn = document.getElementById('arrange-teams-btn');
        const resetBtn = document.getElementById('reset-all-btn');
        const errorMsgEl = document.getElementById('error-message');
        const debugErrorMsgEl = document.getElementById('debug-error-message');

        const teamsOutput = document.getElementById('teams-output');
        const subsOutput = document.getElementById('subs-list');
        const emptySubsMsg = document.getElementById('empty-subs-msg');

        const teamCountSpan = document.getElementById('team-count');
        const subCountSpan = document.getElementById('sub-count');

        const excelFileInput = document.getElementById('excel-file-input');
        const dropZone = document.getElementById('drop-zone');
        const clickToUploadSpan = document.getElementById('click-to-upload');


        // ===================================================
        // === äº‹ä»¶ç›‘å¬å™¨ (ç¨‹åºå…¥å£) ===
        // ===================================================
        document.addEventListener('DOMContentLoaded', () => {

            // 1. ç›‘å¬æ·»åŠ æˆå‘˜è¡¨å•
            addMemberForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const gameId = e.target.gameId.value.trim();
                const role = e.target.role.value;
                const isCommander = e.target.isCommander.checked;
                const isHighLevel = e.target.isHighLevel.checked;
                const notes = e.target.notes.value.trim();

                if (!gameId || !role) {
                    showError("æ¸¸æˆIDå’ŒèŒä¸šä¸èƒ½ä¸ºç©ºï¼");
                    return;
                }

                const newMember = {
                    uniqueId: crypto.randomUUID(), // å…³é”®ï¼šæ·»åŠ å”¯ä¸€ID
                    id: gameId,
                    role: role,
                    isCommander: isCommander,
                    isHighLevel: isHighLevel,
                    notes: notes
                };

                localMembers.push(newMember);
                renderMemberList(localMembers);

                addMemberForm.reset();
                // æ¢å¤é»˜è®¤é€‰ä¸­
                document.getElementById('role-output').checked = true;
                e.target.gameId.focus();
                showError(""); // æ¸…é™¤é”™è¯¯
            });

            // 2. ç›‘å¬æˆå‘˜åˆ—è¡¨çš„åˆ é™¤æŒ‰é’® (äº‹ä»¶å§”æ‰˜)
            memberListContainer.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-member-btn');
                if (removeBtn) {
                    // å…³é”®ï¼šä½¿ç”¨ uniqueId åˆ é™¤
                    const uniqueId = removeBtn.dataset.uniqueId;
                    if (!uniqueId) return;

                    // ä» localMembers ä¸­ç§»é™¤
                    localMembers = localMembers.filter(m => m.uniqueId !== uniqueId);
                    renderMemberList(localMembers);
                }
            });

            // 3. ç›‘å¬æ¸…ç©ºæ•°æ®æŒ‰é’®
            resetBtn.addEventListener('click', () => {
                if (confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æŠ¥åæ•°æ®å’Œåˆ†è½¦ç»“æœå—ï¼Ÿ")) {
                    localMembers = [];
                    generatedTeams = [];
                    generatedHLTargets = {};

                    renderMemberList(localMembers);
                    clearResults();
                    showError("å·²æ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•°æ®ã€‚");
                }
            });

            // 4. ç›‘å¬å¼€å§‹æ’å›¢æŒ‰é’®
            arrangeBtn.addEventListener('click', () => {
                clearResults();
                if (localMembers.length === 0) {
                    showError("æŠ¥ååˆ—è¡¨ä¸ºç©ºï¼Œè¯·å…ˆæ·»åŠ æˆå‘˜æˆ–å¯¼å…¥Excelã€‚");
                    return;
                }

                // === æ’å›¢é€»è¾‘ (ä¸åŸç‰ˆä¸€è‡´) ===
                const TEAM_SIZE = 10;
                let remainingMembers = [...localMembers]; // ä½¿ç”¨æœ¬åœ°æ•°æ®
                const numTeams = Math.floor(remainingMembers.length / TEAM_SIZE);

                if (numTeams === 0) {
                    showError(`äººæ•°ä¸è¶³ ${TEAM_SIZE} äººï¼Œæ— æ³•ç»„è½¦ã€‚`);
                    renderSubstitutes(remainingMembers);
                    return;
                }

                let teams = Array.from({ length: numTeams }, (_, i) => ({ id: i + 1, members: [], errors: [] }));
                let substitutes = [];

                const totalCommanders = remainingMembers.filter(m => m.isCommander).length;
                const totalHighLevelHealers = remainingMembers.filter(m => m.isHighLevel && m.role === 'healer').length;

                if (totalCommanders < numTeams) showError(`æŒ‡æŒ¥ä¸è¶³ï¼éœ€è¦ ${numTeams} åæŒ‡æŒ¥ï¼Œå®é™…åªæœ‰ ${totalCommanders} åæŒ‡æŒ¥ã€‚`);
                if (totalHighLevelHealers < numTeams) showError(`é«˜æˆ˜å¥¶å¦ˆä¸è¶³ï¼éœ€è¦ ${numTeams} åé«˜æˆ˜å¥¶å¦ˆï¼Œå®é™…åªæœ‰ ${totalHighLevelHealers} åé«˜æˆ˜å¥¶å¦ˆã€‚`);

                function canAdd(member, team) {
                    if (team.members.length >= TEAM_SIZE) return false;
                    if (team.members.some(m => m.id === member.id)) return false;
                    if (member.isCommander && team.members.some(m => m.isCommander)) return false;
                    if (member.role === 'healer' && team.members.filter(m => m.role === 'healer').length >= 2) return false;
                    return true;
                }

                function addMemberToTeam(member, team) {
                    team.members.push(member);
                    // å…³é”®ï¼šè¿™é‡Œæ˜¯æŒ‰ uniqueId (å”¯ä¸€ID) ç§»é™¤
                    const index = remainingMembers.findIndex(m => m.uniqueId === member.uniqueId);
                    if (index > -1) remainingMembers.splice(index, 1);
                }

                // ä¼˜å…ˆæ”¾æŒ‡æŒ¥
                let commanders = remainingMembers.filter(m => m.isCommander);
                teams.forEach(team => {
                    let placed = false;
                    for (let i = 0; i < commanders.length; i++) {
                        let commander = commanders[i];
                        if (canAdd(commander, team)) { addMemberToTeam(commander, team); commanders.splice(i, 1); placed = true; break; }
                    }
                    if (!placed) team.errors.push("ç¼ºå°‘æŒ‡æŒ¥");
                });

                // å…¶æ¬¡æ”¾é«˜æˆ˜å¥¶
                let highLevelHealers = remainingMembers.filter(m => m.role === 'healer' && m.isHighLevel);
                teams.forEach(team => {
                    if (team.members.some(m => m.role === 'healer' && m.isHighLevel)) return;
                    let placed = false;
                    for (let i = 0; i < highLevelHealers.length; i++) {
                        let healer = highLevelHealers[i];
                        if (canAdd(healer, team)) { addMemberToTeam(healer, team); highLevelHealers.splice(i, 1); placed = true; break; }
                    }
                    if (!placed) team.errors.push("ç¼ºå°‘é«˜æˆ˜å¥¶å¦ˆ");
                });

                // å‡è¡¡é«˜æˆ˜
                const totalHighLevel = localMembers.filter(m => m.isHighLevel).length;
                const avgHighLevel = (numTeams > 0) ? Math.round(totalHighLevel / numTeams) : 0;
                const highLevelTargetMin = Math.max(0, avgHighLevel - 1);
                const highLevelTargetMax = avgHighLevel + 1;

                // å‰©ä½™çš„äºº
                let highLevelPool = remainingMembers.filter(m => m.isHighLevel);
                let normalHealers = remainingMembers.filter(m => !m.isHighLevel && m.role === 'healer');
                let normalOutputs = remainingMembers.filter(m => !m.isHighLevel && m.role === 'output');

                const placementPools = [{ pool: highLevelPool }, { pool: normalHealers }, { pool: normalOutputs }];

                placementPools.forEach(poolData => {
                    let pool = poolData.pool;
                    while(pool.length > 0) {
                        let member = pool.shift();
                        let placed = false;
                        let sortedTeams = [...teams].sort((a, b) => {
                            if (a.members.length !== b.members.length) return a.members.length - b.members.length;
                            if (member.isHighLevel) return a.members.filter(m => m.isHighLevel).length - b.members.filter(m => m.isHighLevel).length;
                            if (member.role === 'healer') return a.members.filter(m => m.role === 'healer').length - b.members.filter(m => m.role === 'healer').length;
                            return 0;
                        });
                        for (let team of sortedTeams) {
                            if (member.isHighLevel && team.members.filter(m => m.isHighLevel).length >= highLevelTargetMax) continue;
                            if (canAdd(member, team)) { addMemberToTeam(member, team); placed = true; break; }
                        }
                        if (!placed) substitutes.push(member);
                    }
                });

                substitutes = [...substitutes, ...remainingMembers];

                // å­˜å‚¨ç»“æœåˆ°å…¨å±€å˜é‡
                generatedTeams = teams;
                generatedHLTargets = { min: highLevelTargetMin, max: highLevelTargetMax };

                renderTeams(generatedTeams, generatedHLTargets);
                renderSubstitutes(substitutes);
            });

            // 5. ç›‘å¬ Excel æ–‡ä»¶å¯¼å…¥ (ç‚¹å‡»)
            excelFileInput.addEventListener('change', (event) => {
                processExcelFile(event.target.files[0]);
                // æ¸…ç©º input valueï¼Œä»¥ä¾¿ç”¨æˆ·å†æ¬¡é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶æ—¶èƒ½è§¦å‘ change äº‹ä»¶
                event.target.value = null;
            });

            // 6. æ‹–æ‹½åŒºåŸŸç‚¹å‡»äº‹ä»¶ï¼šç‚¹å‡»æ–‡å­—æ—¶è§¦å‘æ–‡ä»¶é€‰æ‹©
            clickToUploadSpan.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°çˆ¶çº§ drop-zone
                excelFileInput.click();
            });

            // 7. æ‹–æ‹½åŒºåŸŸäº‹ä»¶ç›‘å¬
            dropZone.addEventListener('dragover', handleDragOver);
            dropZone.addEventListener('dragleave', handleDragLeave);
            dropZone.addEventListener('drop', handleDropFile);

            // 8. ç›‘å¬å›¢é˜Ÿå†…éƒ¨çš„æ‹–æ‹½äº‹ä»¶ (äº‹ä»¶å§”æ‰˜åˆ° teamsOutput)
            teamsOutput.addEventListener('dragstart', handleDragStart);
            teamsOutput.addEventListener('dragover', handleDragOverMember);
            teamsOutput.addEventListener('dragleave', handleDragLeaveMember);
            teamsOutput.addEventListener('drop', handleDropMember);
            teamsOutput.addEventListener('dragend', handleDragEnd);
        });

        // ===================================================
        // === æ ¸å¿ƒæ•°æ®å¤„ç†å‡½æ•° (Excel) ===
        // ===================================================

        /**
         * æ ¸å¿ƒï¼šè¯»å–å¹¶å¤„ç† Excel æ–‡ä»¶ã€‚
         * @param {File} file - å¾…å¤„ç†çš„æ–‡ä»¶å¯¹è±¡ã€‚
         */
        function processExcelFile(file) {
            if (!file) {
                showError("æœªé€‰æ‹©ä»»ä½•æ–‡ä»¶ã€‚");
                return;
            }
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                 showError("è¯·ç¡®ä¿æ–‡ä»¶æ˜¯ .xlsx æˆ– .xls æ ¼å¼ã€‚");
                 return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet);

                    parseAndAddMembers(json);

                } catch (err) {
                    showError("Excel æ–‡ä»¶è¯»å–å¤±è´¥ï¼è¯·æ£€æŸ¥æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚", err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function parseAndAddMembers(data) {
            let addedCount = 0;
            let skippedCount = 0;

            data.forEach(row => {
                // å¯»æ‰¾åŒ¹é…çš„åˆ—å (å…¼å®¹å¤§å°å†™å’Œç©ºæ ¼)
                const normalize = (s) => s.trim().toLowerCase();

                const idKey = Object.keys(row).find(k => normalize(k).startsWith('é©¾é©¶å‘˜id'));
                const healerKey = Object.keys(row).find(k => normalize(k).startsWith('æ˜¯å¦æ˜¯å¥¶å¦ˆ'));
                const commanderKey = Object.keys(row).find(k => normalize(k).startsWith('æ˜¯å¦æ˜¯æŒ‡æŒ¥'));
                const highLevelKey = Object.keys(row).find(k => normalize(k).startsWith('æ˜¯å¦æœ‰æœ¬æµæ´¾å…­é‡å¿ƒæ³•'));
                const notesKey = Object.keys(row).find(k => normalize(k).startsWith('å¤‡æ³¨'));

                const gameId = row[idKey] ? String(row[idKey]).trim() : null;

                if (!gameId) {
                    skippedCount++;
                    return; // è·³è¿‡æ²¡æœ‰IDçš„è¡Œ
                }

                // è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥æ˜¯å¦ä¸º "æ˜¯"
                // åªè¦ä¸æ˜¯ 'å¦', '0', 'no', 'false', æˆ–ç©ºå­—ç¬¦ä¸²/null/undefinedï¼Œå°±è®¤ä¸ºæ˜¯ True
                const isTrue = (val) => val && !['å¦', '0', 'no', 'false', ''].includes(String(val).trim().toLowerCase());

                const newMember = {
                    uniqueId: crypto.randomUUID(), // å…³é”®ï¼šæ·»åŠ å”¯ä¸€ID
                    id: gameId,
                    role: isTrue(row[healerKey]) ? 'healer' : 'output',
                    isCommander: isTrue(row[commanderKey]),
                    isHighLevel: isTrue(row[highLevelKey]),
                    notes: row[notesKey] ? String(row[notesKey]).trim() : ''
                };

                localMembers.push(newMember);
                addedCount++;
            });

            renderMemberList(localMembers);
            showError(`å¯¼å…¥å®Œæˆï¼šæˆåŠŸæ·»åŠ  ${addedCount} äººï¼Œè·³è¿‡ ${skippedCount} äºº (IDä¸ºç©º)ã€‚`);
        }

        // ===================================================
        // === æ‹–æ‹½ä¸Šä¼ æ–‡ä»¶é€»è¾‘ (Drop Zone) ===
        // ===================================================
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('drag-over');
            e.dataTransfer.dropEffect = 'copy';
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('drag-over');
        }

        function handleDropFile(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('drag-over');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                // åªå¤„ç†ç¬¬ä¸€ä¸ªæ–‡ä»¶
                processExcelFile(files[0]);
            }
        }

        // ===================================================
        // === æ¸²æŸ“ä¸UIå‡½æ•° ===
        // ===================================================

        function renderMemberList(members) {
            memberListContainer.innerHTML = ''; // æ¸…ç©º
            if (members.length === 0) {
                emptyListMsg.textContent = "æš‚æ— æˆå‘˜ï¼Œè¯·åœ¨ä¸Šæ–¹æ·»åŠ æˆ–å¯¼å…¥Excelã€‚";
                memberListContainer.appendChild(emptyListMsg);
            } else {
                members.forEach(member => {
                    const memberEl = document.createElement('div');
                    memberEl.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200';
                    let idColorClass = 'text-gray-800 font-semibold';
                    if (member.isCommander) idColorClass = 'text-blue-600 font-bold';
                    else if (member.role === 'healer') idColorClass = 'text-green-700 font-semibold';
                    else if (!member.isHighLevel) idColorClass = 'text-gray-500';

                    memberEl.innerHTML = `
                        <div class="flex-1 overflow-hidden">
                            <p class="truncate ${idColorClass}" title="${member.id}">${member.id}</p>
                            <div class="flex items-center space-x-2 text-sm mt-1">
                                <span class="px-2 py-0.5 rounded-full ${member.role === 'healer' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${member.role === 'healer' ? 'å¥¶å¦ˆ' : 'è¾“å‡º'}
                                </span>
                                ${member.isHighLevel ? '<span class="px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-800 font-medium">é«˜æˆ˜åŠ›</span>' : ''}
                                ${member.isCommander ? '<span class="px-2 py-0.5 rounded-full bg-blue-100 text-blue-800 font-medium">æŒ‡æŒ¥</span>' : ''}
                            </div>
                            ${member.notes ? `<p class="text-xs text-gray-500 truncate mt-1" title="å¤‡æ³¨: ${member.notes}"><i class="ph-fill ph-info text-xs mr-1"></i>${member.notes}</p>` : ''}
                        </div>
                        <!-- æ³¨æ„ï¼šdata-id ç°åœ¨æ˜¯ uniqueId -->
                        <button data-unique-id="${member.uniqueId}" class="remove-member-btn ml-2 text-gray-400 hover:text-red-600 transition-colors">
                            <i class="ph-bold ph-x text-lg"></i>
                        </button>
                    `;
                    memberListContainer.appendChild(memberEl);
                });
            }
            memberCountSpan.textContent = `${members.length} äºº`;
        }

        function clearResults() {
            teamsOutput.innerHTML = '';
            subsOutput.innerHTML = '';
            if(emptySubsMsg) subsOutput.appendChild(emptySubsMsg);
            teamCountSpan.textContent = '0';
            subCountSpan.textContent = '0';
            showError("");
        }

        function showError(msg, debugMsg = "") {
            errorMsgEl.textContent = msg;
            debugErrorMsgEl.textContent = debugMsg;
        }

        // æ¸²æŸ“å›¢é˜Ÿå¡ç‰‡ (æ ¸å¿ƒæ”¹åŠ¨ï¼šæ·»åŠ æ‹–æ‹½å±æ€§)
        function renderTeams(teams, hlTargets) {
            teamsOutput.innerHTML = '';
            teamCountSpan.textContent = teams.length;

            if (teams.length === 0) {
                teamsOutput.innerHTML = '<p class="text-gray-500 text-center py-4">æœªæˆåŠŸç»„å»ºä»»ä½•å›¢é˜Ÿã€‚</p>';
                return;
            }

            teams.forEach(team => {
                const teamCard = document.createElement('div');
                teamCard.className = 'bg-white p-5 rounded-xl shadow-lg border border-gray-200';

                const healers = team.members.filter(m => m.role === 'healer');
                const highLevels = team.members.filter(m => m.isHighLevel);
                const commander = team.members.find(m => m.isCommander);
                const highLevelHealers = healers.filter(m => m.isHighLevel);

                let hlStatusColor = 'text-green-600';
                if (highLevels.length > hlTargets.max || highLevels.length < hlTargets.min) {
                    hlStatusColor = 'text-yellow-600';
                }

                let memberListHtml = team.members.map(m => {
                    let idColorClass = 'text-gray-800 font-medium';
                    if (m.isCommander) idColorClass = 'text-blue-600 font-bold';
                    else if (m.role === 'healer') idColorClass = 'text-green-700 font-semibold';
                    else if (!m.isHighLevel) idColorClass = 'text-gray-500 font-medium';

                    const notesClass = 'text-gray-600';

                    // å…³é”®ï¼šæ·»åŠ  draggable="true" å’Œ data-unique-id
                    return `
                        <li class="member-item flex items-center p-2 bg-gray-50 rounded-md"
                            draggable="true"
                            data-unique-id="${m.uniqueId}">

                            <span class="w-32 truncate ${idColorClass}" title="${m.id}">${m.id}</span>
                            <span class="text-sm ${m.role === 'healer' ? 'text-green-700' : 'text-red-700'} w-12 flex-shrink-0">${m.role === 'healer' ? 'å¥¶å¦ˆ' : 'è¾“å‡º'}</span>

                            <span class="flex items-center space-x-2 ml-2 min-w-0">
                                ${m.isHighLevel ? '<i class="ph-fill ph-star text-yellow-500 text-sm flex-shrink-0" title="é«˜æˆ˜åŠ›"></i>' : '<i class="ph ph-star text-gray-300 text-sm flex-shrink-0" title="æ™®é€šæˆ˜åŠ›"></i>'}
                                ${m.isCommander ? '<i class="ph-fill ph-microphone text-blue-500 text-sm ml-2 flex-shrink-0" title="æŒ‡æŒ¥"></i>' : ''}
                                <!-- å¤‡æ³¨æ˜¾ç¤ºï¼Œç»Ÿä¸€ä½¿ç”¨ text-gray-600 -->
                                ${m.notes ? `<span class="text-xs ${notesClass} truncate ml-2" title="å¤‡æ³¨: ${m.notes}">${m.notes}</span>` : ''}
                            </span>
                        </li>
                    `;
                }).join('');

                let errorHtml = team.errors.map(err => `<span class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs font-semibold">${err}</span>`).join(' ');

                teamCard.innerHTML = `
                    <h3 class="text-xl font-bold text-indigo-700 mb-3 pb-3 border-b border-indigo-100">
                        ç¬¬ ${team.id} è½¦
                        ${team.members.length < 10 ? `<span class="text-red-600 font-semibold ml-2">(${team.members.length}/10 äººæœªæ»¡)</span>` : ''}
                    </h3>
                    <div class="flex flex-wrap gap-x-6 gap-y-2 mb-4 text-sm">
                        <span class="font-semibold ${commander ? 'text-gray-700' : 'text-red-600'}">æŒ‡æŒ¥: ${commander ? commander.id : 'æ— '}</span>
                        <span class="font-semibold ${healers.length > 2 || healers.length === 0 ? 'text-red-600' : 'text-gray-700'}">å¥¶å¦ˆ: ${healers.length} äºº</span>
                        <span class="font-semibold ${highLevelHealers.length === 0 ? 'text-red-600' : 'text-gray-700'}">(é«˜æˆ˜å¥¶: ${highLevelHealers.length} äºº)</span>
                        <span class="font-semibold ${hlStatusColor}">é«˜æˆ˜åŠ›: ${highLevels.length} äºº (ç›®æ ‡: ${hlTargets.min}-${hlTargets.max})</span>
                    </div>
                    <div class="mb-3">${errorHtml}</div>
                    <!-- æ³¨æ„ï¼šul åˆ—è¡¨éœ€è¦ä¸€ä¸ª data-team-id æ¥è¾…åŠ© drop äº‹ä»¶ -->
                    <ul class="space-y-1 max-h-60 overflow-y-auto pr-2" data-team-id="${team.id}">
                        ${memberListHtml}
                    </ul>
                `;
                teamsOutput.appendChild(teamCard);
            });
        }

        // æ¸²æŸ“æ›¿è¡¥åˆ—è¡¨
        function renderSubstitutes(subs) {
            subsOutput.innerHTML = '';
            subCountSpan.textContent = subs.length;

            if (subs.length === 0) {
                subsOutput.appendChild(emptySubsMsg);
                return;
            }

            subs.sort((a, b) => a.isHighLevel - b.isHighLevel);

            subs.forEach(member => {
                const subEl = document.createElement('div');
                // å…³é”®ï¼šæ›¿è¡¥äººå‘˜ä¹Ÿæ·»åŠ æ‹–æ‹½å±æ€§
                subEl.className = 'member-item p-2 rounded-lg border flex items-center space-x-2 bg-gray-100';
                subEl.setAttribute('draggable', 'true');
                subEl.setAttribute('data-unique-id', member.uniqueId);

                let idColorClass = 'text-gray-800 font-semibold';
                if (member.isCommander) idColorClass = 'text-blue-600 font-bold';
                else if (member.role === 'healer') idColorClass = 'text-green-700 font-semibold';
                else if (!member.isHighLevel) idColorClass = 'text-gray-500';

                const notesClass = 'text-gray-600';

                subEl.innerHTML = `
                    <span class="${idColorClass} truncate" title="${member.id}">${member.id}</span>
                    <span class="text-xs ${member.role === 'healer' ? 'text-green-700' : 'text-red-700'} flex-shrink-0">(${member.role === 'healer' ? 'å¥¶' : 'è¾“å‡º'})</span>
                    ${member.isHighLevel ? '<i class="ph-fill ph-star text-yellow-500 text-xs flex-shrink-0" title="é«˜æˆ˜åŠ›"></i>' : ''}
                    ${member.isCommander ? '<i class="ph-fill ph-microphone text-blue-500 text-xs ml-1 flex-shrink-0" title="æŒ‡æŒ¥"></i>' : ''}
                    <!-- å¤‡æ³¨æ˜¾ç¤ºï¼Œç»Ÿä¸€ä½¿ç”¨ text-gray-600 -->
                    ${member.notes ? `<span class="text-xs ${notesClass} truncate ml-1" title="å¤‡æ³¨: ${member.notes}">${member.notes}</span>` : ''}
                `;
                subsOutput.appendChild(subEl);
            });
        }

        // ===================================================
        // === æ‹–æ‹½äº¤æ¢æˆå‘˜é€»è¾‘ (Team/Sub) ===
        // ===================================================

        function handleDragStart(e) {
            const target = e.target.closest('.member-item');
            if (target) {
                // å…³é”®ï¼šä½¿ç”¨ data-unique-id
                draggedMemberUniqueId = target.dataset.uniqueId;
                e.dataTransfer.setData('text/plain', draggedMemberUniqueId);
                e.dataTransfer.effectAllowed = 'move';
                target.classList.add('dragging');
            }
        }

        // æ‹–æ‹½åˆ°å›¢é˜Ÿæˆå‘˜ä¸Šæ–¹
        function handleDragOverMember(e) {
            e.preventDefault();
            const target = e.target.closest('.member-item');
            // å…³é”®ï¼šä½¿ç”¨ data-unique-id æ¯”è¾ƒ
            if (target && target.dataset.uniqueId !== draggedMemberUniqueId) {
                target.classList.add('drag-over-target');
                e.dataTransfer.dropEffect = 'move';
            }
        }

        function handleDragLeaveMember(e) {
             const target = e.target.closest('.member-item');
             if (target) {
                target.classList.remove('drag-over-target');
             }
        }

        function handleDropMember(e) {
            e.preventDefault();
            const targetMemberEl = e.target.closest('.member-item');

            // æ¸…ç†è§†è§‰æ•ˆæœ
            document.querySelectorAll('.drag-over-target').forEach(el => el.classList.remove('drag-over-target'));

            if (!targetMemberEl || !draggedMemberUniqueId) return;

            // å…³é”®ï¼šä½¿ç”¨ data-unique-id
            const targetMemberUniqueId = targetMemberEl.dataset.uniqueId;

            // ä¸å…è®¸æ‹–åˆ°è‡ªå·±èº«ä¸Š
            if (draggedMemberUniqueId === targetMemberUniqueId) return;

            // æ‰¾åˆ°æ‹–æ‹½è€…å’Œç›®æ ‡çš„ä½ç½®ï¼Œå¯èƒ½åœ¨å›¢é˜Ÿä¸­ï¼Œä¹Ÿå¯èƒ½åœ¨æ›¿è¡¥å¸­
            let draggedInfo = findMemberLocation(draggedMemberUniqueId);
            let targetInfo = findMemberLocation(targetMemberUniqueId);

            if (draggedInfo && targetInfo) {
                // 1. è·å–æ‹–æ‹½è€…å’Œç›®æ ‡æˆå‘˜å¯¹è±¡
                const draggedMember = draggedInfo.member;
                const targetMember = targetInfo.member;

                // 2. æ‰§è¡Œæ•°æ®äº¤æ¢
                // ä»æ‹–æ‹½æºç§»é™¤
                draggedInfo.list.splice(draggedInfo.index, 1);

                // æ’å…¥åˆ°ç›®æ ‡ä½ç½®
                targetInfo.list.splice(targetInfo.index, 0, draggedMember);

                // 3. å¦‚æœæºå’Œç›®æ ‡åˆ—è¡¨ä¸åŒï¼Œè¿˜éœ€è¦ä»ç›®æ ‡ç§»é™¤ç›®æ ‡æˆå‘˜ï¼Œå¹¶æ’å…¥åˆ°æºä½ç½®
                if (draggedInfo.list !== targetInfo.list) {
                    // å› ä¸ºç¬¬äºŒæ­¥å·²ç»æŠŠç›®æ ‡æˆå‘˜å¾€åæŒ¤äº†ï¼Œæ‰€ä»¥ç°åœ¨ç›®æ ‡æˆå‘˜åœ¨ targetInfo.index + 1
                    targetInfo.list.splice(targetInfo.index + 1, 1);

                    // æ’å…¥åˆ°æ‹–æ‹½æº
                    draggedInfo.list.splice(draggedInfo.index, 0, targetMember);
                } else {
                    // å¦‚æœåœ¨åŒä¸€ä¸ªåˆ—è¡¨å†…ï¼Œç¬¬äºŒæ­¥æ’å…¥åï¼Œç›®æ ‡æˆå‘˜çš„ä½ç½®å·²ç»å˜åŒ–ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
                    // ç®€å•æ–¹æ³•ï¼šç›´æ¥é‡æ–°æ¸²æŸ“ï¼Œå› ä¸º splice ç§»åŠ¨å…ƒç´ å¾ˆå¤æ‚
                    // æ”¾å¼ƒå¤æ‚ splice é€»è¾‘ï¼Œç›´æ¥äº¤æ¢å¯¹è±¡å±æ€§ï¼ˆå¦‚æœåŒåˆ—è¡¨ï¼‰ï¼Œæˆ–ç§»é™¤/æ·»åŠ ï¼ˆå¦‚æœä¸åŒåˆ—è¡¨ï¼‰

                    // ç®€åŒ–é€»è¾‘ï¼šåªå¤„ç†äº¤æ¢
                    draggedInfo.list[draggedInfo.index] = targetMember;
                    targetInfo.list[targetInfo.index] = draggedMember;
                }

                // äº¤æ¢å®Œæˆï¼Œé‡æ–°æ¸²æŸ“æ‰€æœ‰ (æœ€å®‰å…¨çš„æ–¹å¼)
                renderTeams(generatedTeams, generatedHLTargets);
                renderSubstitutes(getGeneratedSubs()); // ä½¿ç”¨è¾…åŠ©å‡½æ•°é‡æ–°è·å–æ›¿è¡¥åˆ—è¡¨
                showError(`äº¤æ¢æˆåŠŸï¼š${draggedMember.id} <-> ${targetMember.id}`);
            } else {
                showError("äº¤æ¢å¤±è´¥ï¼šæœªèƒ½åœ¨æ•°æ®ä¸­æ‰¾åˆ°æˆå‘˜ã€‚");
            }
        }

        function handleDragEnd(e) {
            // æ¸…ç†
            document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
            draggedMemberUniqueId = null;
        }

        /**
         * è¾…åŠ©å‡½æ•°ï¼šåœ¨ generatedTeams å’Œ subs ä¸­æŸ¥æ‰¾æˆå‘˜
         * @param {string} uniqueId
         * @returns {object|null} { member, team (optional), index, list (reference to team.members or generatedSubs) }
         */
        function findMemberLocation(uniqueId) {
            // 1. åœ¨å›¢é˜Ÿä¸­æŸ¥æ‰¾
            for (const team of generatedTeams) {
                const memberIndex = team.members.findIndex(m => m.uniqueId === uniqueId);
                if (memberIndex !== -1) {
                    return {
                        member: team.members[memberIndex],
                        team: team,
                        index: memberIndex,
                        list: team.members
                    };
                }
            }

            // 2. åœ¨æ›¿è¡¥å¸­æŸ¥æ‰¾ (å¦‚æœæ›¿è¡¥åˆ—è¡¨å·²ç”Ÿæˆ)
            const generatedSubs = getGeneratedSubs();
            if (generatedSubs && generatedSubs.length > 0) {
                 const memberIndex = generatedSubs.findIndex(m => m.uniqueId === uniqueId);
                 if (memberIndex !== -1) {
                    return {
                        member: generatedSubs[memberIndex],
                        team: null,
                        index: memberIndex,
                        list: generatedSubs
                    };
                 }
            }
            return null; // æœªæ‰¾åˆ°
        }

        // è¾…åŠ©å‡½æ•°ï¼šé‡æ–°è·å–å½“å‰æ›¿è¡¥äººå‘˜åˆ—è¡¨
        function getGeneratedSubs() {
             // ä» localMembers ä¸­æå–æœªè¢«åˆ†é…åˆ° team.members çš„æˆå‘˜
             let substitutes = [];
             const allTeamMemberIds = new Set();
             generatedTeams.forEach(team => team.members.forEach(m => allTeamMemberIds.add(m.uniqueId)));

             localMembers.forEach(m => {
                 if (!allTeamMemberIds.has(m.uniqueId)) {
                     substitutes.push(m);
                 }
             });
             return substitutes;
        }

    </script>
</body>
</html>
